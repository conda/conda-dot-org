#! /usr/bin/env python
"""
This is a script to help us keep our "blog/news.json" file up to
date. It will scan the "blog" directory, sort items by date (which
is just title) and then read the metadata from the entries to update
the "news.json" file.
"""
from __future__ import annotations

import datetime
import json
import os
import re
import sys
from typing import Sequence, Any, Iterator

try:
    import yaml
except ImportError:
    print("Please install PyYaml to use this script")
    sys.exit(1)


BLOGS_DIR = "./blog"
NEWS_FILE = os.path.join(BLOGS_DIR, "news.json")

#: Matches anything that begins with a time stamp (e.g. 2023-03-23-something)
BLOGS_TITLE_PAT = re.compile(r"([0-9]{4}-[0-9]{2}-[0-9]{2})(.+)")


def has_blog_title_pattern(item: str) -> bool:
    match = BLOGS_TITLE_PAT.match(item)

    return match is not None

def has_index_file_ending(item: str) -> bool:
    return item.endswith("index.md") or item.endswith("index.mdx")


def get_blog_files() -> tuple[str]:
    """
    Returns all the blog files that we need to include in the "news.json" file.
    This is only the five newest according to the date in the title.
    """
    blogs_listing = tuple(
        os.path.join(BLOGS_DIR, item) for item in
        filter(has_blog_title_pattern, os.listdir(BLOGS_DIR))
    )
    blogs_dirs = filter(os.path.isdir, blogs_listing)
    blogs_files = filter(os.path.isfile, blogs_listing)

    blogs_dirs_files = (
        os.path.join(dir, item)
        for dir in blogs_dirs
        for item in os.listdir(dir)
        if has_index_file_ending(item)
    )

    return sorted(tuple(blogs_files) + tuple(blogs_dirs_files), reverse=True)[:5]


def get_date_from_filename(filename) -> datetime.datetime | None:
    rest, base = os.path.split(filename)

    if has_index_file_ending(filename):
        base = os.path.basename(rest)
    
    pat_match = BLOGS_TITLE_PAT.match(base)

    if pat_match:
        date_str = pat_match.group(1)
        return datetime.datetime.strptime(date_str, "%Y-%m-%d")


def get_file_data(files: Sequence[str]) -> Iterator[dict[str, Any]]:
    """
    Reads the file and returns the data contained within the frontmatter.
    """
    for idx, file in enumerate(files):
        with open(file, "r") as handle:
            parts = handle.read().split("---")
            if len(parts) > 1:
                yml_part = parts[1]
                yml_part = yml_part.strip("\n")
                yml_obj = yaml.load(yml_part, yaml.CLoader)
                date = get_date_from_filename(file)

                # We only want to have "image" present for the first listing
                if idx == 0:
                    image = yml_obj.get("image")
                else:
                    image = None

                if date is not None:
                    yield {**yml_obj, "date": date.isoformat(), "image": image}


def main():
    blog_files = get_blog_files()
    file_data = tuple(get_file_data(blog_files))

    with open(NEWS_FILE, "w") as handle:
        json.dump(file_data, handle)


if __name__ == "__main__":
    main()
